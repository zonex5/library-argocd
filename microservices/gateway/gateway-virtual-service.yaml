apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: ms-services
  namespace: ms
spec:
  hosts:
    - "*"
  gateways:
    - ms-gateway
  http:
    - match:
        - uri:
            prefix: /books
        - uri:
            prefix: /authors
      route:
        - destination:
            host: book-service.ms.svc.cluster.local
            subset: stable
          weight: 90
        - destination:
            host: book-service.ms.svc.cluster.local
            subset: canary
          weight: 10
      headers:
        request:
          add:
            X-User-Session: "{request.headers['user-agent'] | request.headers['cookie']}"
      fault:
        headerHashPolicy:
          headerName: X-User-Session
    - match:
        - uri:
            prefix: /libraries
        - uri:
            prefix: /stock
      route:
        - destination:
            host: library-service.ms.svc.cluster.local
            port:
              number: 80
    - match:
        - uri:
            prefix: /search
      route:
        - destination:
            host: search-service.ms.svc.cluster.local
            port:
              number: 80
